<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>채팅</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let currentMeetId = null;
        let lastChatId = 0;

        function getCookie(name) {
            return document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1] || null;
        }

        const userId = getCookie("userId");
        const userName = getCookie("userName");

        function loadPreviousChats(meetId) {
            console.log("Received meetId:", meetId, "Type:", typeof meetId);

            if (!meetId) {
                console.error("meetId가 올바르지 않습니다!", meetId);
                return;
            }

            // lastChatId가 undefined일 경우 0으로 설정
            if (lastChatId === null || lastChatId === undefined) {
                lastChatId = 0;
            }

            fetch(`/api/chat/${meetId}?lastChatId=${lastChatId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`서버 응답 오류: ${response.status}`);
                    }
                    return response.json();
                })
                .then(chatDtos => {
                    console.log(chatDtos);
                    if (chatDtos.length > 0) {
                        chatDtos.reverse().forEach(chatDto => {
                            const formattedTime = new Date(chatDto.createdAt).toLocaleString();
                            const senderName = chatDto.userName || "알 수 없는 사용자";

                            const chatElement = document.createElement('p');
                            chatElement.innerHTML = `<strong>${senderName}</strong> [${formattedTime}]: ${chatDto.messageContent}`;
                            document.getElementById("chat-box").insertBefore(chatElement, document.getElementById("chat-box").firstChild);
                        });

                        // 가장 마지막 메시지의 ID 업데이트
                        lastChatId = chatDtos[chatDtos.length - 1].messageId;
                    }
                })
                .catch(error => console.error('Error loading chat history:', error));
        }


        function connect(meetId) {
            if (currentMeetId === meetId) return;
            currentMeetId = meetId;
            lastChatId = 0;
            document.getElementById("chat-box").innerHTML = "";
            loadPreviousChats(meetId);

            if (stompClient) {
                stompClient.disconnect(() => {
                    console.log(`기존 WebSocket 연결 해제`);
                    initializeWebSocket(meetId);
                });
            } else {
                initializeWebSocket(meetId);
            }
        }

        function initializeWebSocket(meetId) {
            let socket = new SockJS('http://localhost:8080/ws', null, {withCredentials: true});
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function () {
                console.log(`Connected to meetId: ${meetId}`);
                stompClient.subscribe(`/topic/chat/${meetId}`, function (message) {
                    const content = JSON.parse(message.body);
                    if (content.userId !== userId) {
                        appendMessage(content.userName, content.messageContent, content.createdAt);
                    }
                });
            });
        }

        function sendMessage() {
            const messageContent = document.getElementById("message-input").value;
            if (!currentMeetId || !messageContent || !stompClient) return;

            const chatMessage = {
                messageContent,
                userId,
                userName,
                createdAt: new Date(),
                meetId: currentMeetId
            };
            stompClient.send(`/app/chat/${currentMeetId}`, {}, JSON.stringify(chatMessage));
            appendMessage(userName, messageContent, new Date());
            document.getElementById("message-input").value = "";
        }

        function appendMessage(sender, message, timestamp) {
            const chatBox = document.getElementById("chat-box");
            const chatElement = document.createElement("p");
            chatElement.innerHTML = `<strong>${sender || "알 수 없는 사용자"}</strong> [${new Date(timestamp).toLocaleString()}]: ${message}`;
            chatBox.appendChild(chatElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        window.onload = function () {
            document.getElementById("welcome-text").innerText = userName ? `환영합니다, ${userName}님` : "환영합니다!";
            document.getElementById("login-btn").style.display = userId ? "none" : "block";
            document.getElementById("logout-btn").style.display = userId ? "block" : "none";
            document.getElementById("chat-box").addEventListener("scroll", function () {
                if (this.scrollTop === 0) loadPreviousChats(currentMeetId);
            });
            connect(1);
        };
    </script>
</head>
<body>
<h2 id="welcome-text">환영합니다!</h2>
<div id="auth-buttons">
    <a href="/auth/kakao/login" id="login-btn">카카오 로그인</a>
    <a href="/auth/kakao/logout" id="logout-btn" style="display: none;">로그아웃</a>
</div>
<button onclick="connect(1)">채팅방 1 접속</button>
<button onclick="connect(2)">채팅방 2 접속</button>
<div id="chat-box"
     style="border: 1px solid #ccc; padding: 10px; margin-top: 10px; height: 200px; overflow-y: auto;"></div>
<input id="message-input" placeholder="메시지를 입력하세요..." type="text"/>
<button onclick="sendMessage()">전송</button>
</body>
</html>
